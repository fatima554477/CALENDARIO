New-Item -ItemType Directory -Force -Path .\alexa-chatgpt-skill\lambda,.\alexa-chatgpt-skill\interactionModels\custom,.\alexa-chatgpt-skill\skill-package

# Crear carpetas
New-Item -ItemType Directory -Force -Path .\alexa-chatgpt-skill\lambda,.\alexa-chatgpt-skill\interactionModels\custom,.\alexa-chatgpt-skill\skill-package

# index.js
@'
/* Alexa + ChatGPT (OpenAI) Skill - Español México */
const Alexa = require('ask-sdk-core');
const fetchFn = (...args) => import('node-fetch').then(({default: fetch}) => fetch(...args));

const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const OPENAI_MODEL = process.env.OPENAI_MODEL || "gpt-3.5-turbo";

function toSSML(text) {
  let safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  const parts = safe.split(/\n{2,}/).map(p => `<p>${p.trim()}</p>`).join("");
  return `<speak>${parts.slice(0,7600)}</speak>`;
}

async function askOpenAI(prompt, sessionHistory=[]) {
  const history = sessionHistory.slice(-8);
  const messages = [
    { role: "system", content: "Eres ChatGPT en Alexa en español (México)." },
    ...history,
    { role: "user", content: prompt }
  ];
  const res = await fetchFn("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${OPENAI_API_KEY}`
    },
    body: JSON.stringify({ model: OPENAI_MODEL, messages })
  });
  const data = await res.json();
  return data.choices?.[0]?.message?.content || "Lo siento, no pude responder.";
}

const LaunchRequestHandler = {
  canHandle(h) { return Alexa.getRequestType(h.requestEnvelope) === 'LaunchRequest'; },
  handle(h) {
    return h.responseBuilder
      .speak(toSSML("¡Hola! Soy ChatGPT en Alexa. ¿Qué te gustaría saber?"))
      .reprompt(toSSML("¿Sobre qué tema quieres que hablemos?"))
      .getResponse();
  }
};

const ChatGPTIntentHandler = {
  canHandle(h) {
    return Alexa.getRequestType(h.requestEnvelope) === 'IntentRequest'
      && Alexa.getIntentName(h.requestEnvelope) === 'ChatGPTIntent';
  },
  async handle(h) {
    const sessionAttributes = h.attributesManager.getSessionAttributes() || {};
    const history = sessionAttributes.history || [];
    const userInput = h.requestEnvelope.request.intent.slots.prompt.value || '';
    if (!userInput) {
      return h.responseBuilder
        .speak(toSSML("Dime tu pregunta."))
        .reprompt(toSSML("¿Qué quieres saber?"))
        .getResponse();
    }
    const newHistory = history.concat([{ role:"user", content:userInput }]).slice(-8);
    const gptReply = await askOpenAI(userInput, newHistory);
    sessionAttributes.history = newHistory.concat([{ role:"assistant", content:gptReply }]);
    h.attributesManager.setSessionAttributes(sessionAttributes);
    return h.responseBuilder.speak(toSSML(gptReply)).reprompt(toSSML("¿Quieres preguntar algo más?")).getResponse();
  }
};

exports.handler = Alexa.SkillBuilders.custom()
  .addRequestHandlers(LaunchRequestHandler, ChatGPTIntentHandler)
  .lambda();
'@ | Set-Content .\alexa-chatgpt-skill\lambda\index.js

# package.json
@'
{
  "name": "alexa-chatgpt-skill",
  "version": "1.0.0",
  "description": "Skill Alexa conectada a ChatGPT",
  "main": "index.js",
  "dependencies": {
    "ask-sdk-core": "^2.12.1",
    "node-fetch": "^2.6.7"
  }
}
'@ | Set-Content .\alexa-chatgpt-skill\lambda\package.json

# es-MX.json
@'
{
  "interactionModel": {
    "languageModel": {
      "invocationName": "mi chat g p t",
      "intents": [
        {
          "name": "ChatGPTIntent",
          "samples": [
            "pregúntale a chat g p t {prompt}",
            "chat g p t {prompt}",
            "quiero saber {prompt}",
            "dime {prompt}"
          ],
          "slots": [
            { "name": "prompt", "type": "AMAZON.SearchQuery" }
          ]
        },
        { "name": "AMAZON.HelpIntent", "samples": [] },
        { "name": "AMAZON.CancelIntent", "samples": [] },
        { "name": "AMAZON.StopIntent", "samples": [] }
      ]
    }
  }
}
'@ | Set-Content .\alexa-chatgpt-skill\interactionModels\custom\es-MX.json

# skill.json
@'
{
  "manifest": {
    "publishingInformation": {
      "locales": {
        "es-MX": {
          "summary": "Habla con ChatGPT en Alexa en español.",
          "examplePhrases": [
            "Alexa, abre mi chat g p t",
            "Alexa, pregúntale a chat g p t qué es la metafísica"
          ],
          "name": "Mi ChatGPT",
          "description": "Skill personalizada que conecta Alexa con OpenAI ChatGPT usando la API."
        }
      },
      "isAvailableWorldwide": false,
      "category": "EDUCATION_AND_REFERENCE"
    },
    "apis": { "custom": {} },
    "manifestVersion": "1.0",
    "privacyAndCompliance": {
      "allowsPurchases": false,
      "usesPersonalInfo": false,
      "isChildDirected": false,
      "isExportCompliant": true,
      "containsAds": false
    }
  }
}
'@ | Set-Content .\alexa-chatgpt-skill\skill-package\skill.json

# Crear el ZIP
Compress-Archive -Path .\alexa-chatgpt-skill\* -DestinationPath .\alexa-chatgpt-skill.zip -Force
